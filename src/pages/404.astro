---
import LandingLayout from '@/layouts/LandingLayout.astro';
import Prose from '@/features/Prose.astro';
import Search from 'astro-pagefind/components/Search';
import { t } from '@/utils/translations';
import { DEFAULT_LANG, SUPPORTED_LANGS, toAbsolute } from '@/utils/i18n';

const lang = DEFAULT_LANG;
const title = t(lang, 'notFound.title');
const message = t(lang, 'notFound.message');
const searchHint = t(lang, 'search.subtitle');
const TEXTS = SUPPORTED_LANGS.reduce<Record<string, { title: string; message: string; search: string; back: string; browse: string; home: string; posts: string }>>(
  (acc, l) => {
    acc[l] = {
      title: t(l as any, 'notFound.title'),
      message: t(l as any, 'notFound.message'),
      search: t(l as any, 'search.subtitle'),
      back: t(l as any, 'notFound.backToHome'),
      browse: t(l as any, 'notFound.browsePosts'),
      home: toAbsolute(l as any, '/'),
      posts: toAbsolute(l as any, '/posts/'),
    };
    return acc;
  },
  {},
);
---

<LandingLayout lang={lang} title={title} description={message} canonical={null} noindex>
  <Prose>
    <p id="i18n-search-hint" class="text-center text-sm text-neutral-500 dark:text-neutral-400">{searchHint}</p>
  </Prose>

  <div class="mt-6">
    <div class="mx-auto w-full max-w-2xl">
      <Search id="search-404" className="pagefind-ui w-full" uiOptions={{ showImages: false }} />
    </div>
  </div>

  <div class="mt-6 text-center">
    <div class="inline-flex flex-wrap items-center justify-center gap-2">
      <a
        id="i18n-home-link-1"
        href={toAbsolute(lang, '/')}
        class="inline-flex items-center gap-2 rounded-md border border-neutral-200/70 px-3 py-1.5 text-sm text-neutral-700 hover:bg-neutral-50 dark:border-neutral-800/70 dark:text-neutral-300 dark:hover:bg-neutral-800"
      >
        <span aria-hidden>‚Üê</span>
        <span id="i18n-back">{t(lang, 'notFound.backToHome')}</span>
      </a>
      <a
        id="i18n-home-link-2"
        href={toAbsolute(lang, '/posts/')}
        class="inline-flex items-center gap-2 rounded-md border border-neutral-200/70 px-3 py-1.5 text-sm text-neutral-700 hover:bg-neutral-50 dark:border-neutral-800/70 dark:text-neutral-300 dark:hover:bg-neutral-800"
      >
        <span aria-hidden>üß≠</span>
        <span id="i18n-browse">{t(lang, 'notFound.browsePosts')}</span>
      </a>
    </div>
  </div>
</LandingLayout>

<script is:inline>
  const SUPPORTED = {JSON.stringify(SUPPORTED_LANGS)};
  const TEXTS = {JSON.stringify(TEXTS)};
  const DEFAULT_LANG = {JSON.stringify(DEFAULT_LANG)};
  (function () {
    try {
      function pickLang() {
        var path = window.location.pathname || '/';
        var seg = (path.split('/').filter(Boolean)[0] || '').toLowerCase();
        if (SUPPORTED.includes(seg)) return seg;
        var nav = (navigator.language || navigator.userLanguage || 'en').slice(0, 2).toLowerCase();
        if (SUPPORTED.includes(nav)) return nav;
        return DEFAULT_LANG;
      }
      var l = pickLang();
      var t = TEXTS[l] || TEXTS[DEFAULT_LANG];
      if (!t) return;
      // Update title and meta description
      try { document.title = t.title; } catch (e) {}
      var desc = document.querySelector('meta[name="description"]');
      if (desc) try { desc.setAttribute('content', t.message); } catch (e) {}
      // Swap texts
      var sh = document.getElementById('i18n-search-hint');
      if (sh) sh.textContent = t.search;
      var back = document.getElementById('i18n-back');
      if (back) back.textContent = t.back;
      var browse = document.getElementById('i18n-browse');
      if (browse) browse.textContent = t.browse;
      // Update links
      var a1 = document.getElementById('i18n-home-link-1');
      if (a1) a1.setAttribute('href', t.home);
      var a2 = document.getElementById('i18n-home-link-2');
      if (a2) a2.setAttribute('href', t.posts);
    } catch (e) {
      // no-op
    }
  })();
</script>
